
@{
    ViewData["Title"] = "AlarmShipAll";
    Layout = null;
}

<link href="~/layui/css/layui.css" rel="stylesheet" />
<script src="~/lib/jquery/dist/jquery.js"></script>
<script src="~/layui/layui.js"></script>
<script type="text/javascript">
    var page = 1; //设置首页页码
    var limit = 5; //设置一页显示的条数
    var total; //总条数
    $(function () {
        LoadAlarm();
        getdate();
    });
    function LoadAlarm() {
        var data = {
            pageIndex: page,
            pageSize: limit
        }
        $.ajax({
            url: "/Alarm/LoadAlarm",
            type: "get",
            data: data,
            dataType: "json",
            contentType: "application/json;charset=utf-8",
            success: function (res) {
                if (res.code == 0) {
                    var tb = res.data;
                    var sl = res.ship;
                    if (sl.length > 0) {
                        var slHtml = '<option value="">请选择</option>';
                        for (var i = 0; i < sl.length; i++) {
                            slHtml += '<option value="' + sl[i].id + '">' + sl[i].name + '</option>'
                        }
                        $("#slShip").html(slHtml);
                    }
                    total = res.count;
                    LoadHtml(tb);
                    getPage();
                }
            }
        });
    }
    function LoadHtml(tb) {
        var html = "";
        if (tb.length > 0) {
            for (var i = 0; i < tb.length; i++) {
                html += '<tr>';
                html += '<td>' + tb[i].name + '</td>';
                html += '<td>' + tb[i].time + '</td>';
                html += '<td>' + tb[i].cid + '</td>';
                html += '<td>' + tb[i].nickName + '</td>';
                if (tb[i].type == 1) {
                    html += '<td><img style="width:800px;height:30px" ondblclick="showBigImage(this)"  src="data:image/jpeg;base64,' + tb[i].picture + '"/></td>';
                    html += '<td></td>';
                    html += '<td></td>';
                    html += '<td></td>';
                }
                else if (tb[i].type == 2) {
                    html += '<td></td>';
                    html += '<td><img style="width:800px;height:30px"  ondblclick="showBigImage(this)"  src="data:image/jpeg;base64,' + tb[i].picture + '"/></td>';
                    html += '<td></td>';
                    html += '<td></td>';
                } else if (tb[i].type == 3) {
                    html += '<td></td>';
                    html += '<td></td>';
                    html += '<td><img style="width:800px;height:30px" ondblclick="showBigImage(this)"  src="data:image/jpeg;base64,' + tb[i].picture + '"/></td>';
                    html += '<td></td>';
                } else {
                    html += '<td></td>';
                    html += '<td></td>';
                    html += '<td></td>';
                    html += '<td><img style="width:800px;height:30px"  ondblclick="showBigImage(this)" src="data:image/jpeg;base64,' + tb[i].picture + '"/></td>';
                }
            }
        }

        $("#tblist").html(html);
    }
    function Query(pageIndex, isRefresh = true) {
        var cid = $("#txtUid").val();
        var name = $("#txtName").val();
        var type = $("#slType").val();
        var startTime = $("#dtStartTime").val();
        var endTime = $("#dtEndTime").val();
        var shipId = $("#slShip").val();
        var data = {
            shipId: shipId,
            cid: cid,
            name: name,
            type: parseInt(type),
            startTime: startTime,
            endTime: endTime,
            pageIndex: pageIndex,
            pageSize: limit
        }
        $.ajax({
            url: "/Alarm/SearchAlarm",
            data: {
                searchModel: JSON.stringify(data)
            },
            type: "get",
            dataType: "json",
            contentType: "application/json;chartset=utf-8",
            success: function (res) {
                if (res.code == 0) {
                    total = res.count;
                    var tb = res.data;
                    LoadHtml(tb);
                    if (isRefresh) {
                        getPage();
                    }
                }
            }
        })
    }
    //时间控件
    function getdate() {
        layui.use('laydate', function () {
            var laydate = layui.laydate;
            var layer = layui.layer;
            laydate.render({
                elem: '#dtStartTime',
                type: 'date'
            });
        });
        layui.use('laydate', function () {
            var laydate = layui.laydate;
            var layer = layui.layer;
            laydate.render({
                elem: '#dtEndTime',
                type: 'date'
            });
        })
    };
    //分页处理
    function getPage() {
        layui.use('laypage', function () {
            var laypage = layui.laypage;
            var layer = layui.layer;
            laypage.render({
                elem: 'pages',
                count: total, //数据总数，从服务端得到
                limit: limit,
                jump: function (obj, first) {
                    page = obj.curr; //改变当前页码
                    limit = obj.limit;
                    if (!first) {
                        Query(page, false);
                    }
                }
            });
        });
    }
    function showBigImage(e) {
        layui.use('layer', function () { //独立版的layer无需执行这一句
            var $ = layui.jquery, layer = layui.layer; //独立版的layer无需执行这一句
            var x = document.documentElement.clientWidth / 6;
            var y = document.documentElement.clientHeight / 6;
            var windowW = 960;
            var windowH = 540;
            layer.open({
                type: 1,
                offset: [y + "px", x + "px"],
                title: false,
                closeBtn: true,
                id: 'LAY_layuipro',
                shadeClose: true, //点击阴影关闭
                area: [windowW + 'px', windowH + 'px'], //宽高
                content: "<img style=\"position: absolute;width:100%;height:100%\" src=" + $(e).attr('src') + " />"
            });
        });
    }
</script>

<div id="divAlarm" style="margin:20px;width:96%">
    <div class="layui-form-item">
        <label class="layui-form-label">编号</label>
        <div class="layui-input-inline" style="width:100px">
            <input id="txtUid" class="layui-input" type="text" placeholder="请输入" autocomplete="off" lay-verify="required">
        </div>
        <label class="layui-form-label">名称</label>
        <div class="layui-input-inline" style="width:100px">
            <input id="txtName" class="layui-input" type="text" placeholder="请输入" autocomplete="off" lay-verify="required">
        </div>
        <label class="layui-form-label">类型</label>
        <select id="slType" class="layui-form-label" style="width:100px">
            <option value="0">请选择</option>
            <option value="1">睡觉</option>
            <option value="2">打架</option>
            <option value="3">安全帽</option>
            <option value="4">手机</option>
        </select>
        <label class="layui-form-label">船舶</label>
        <select id="slShip" class="layui-form-label" style="width:100px">
        </select>
        <label class="layui-form-label">时间起</label>
        <div class="layui-input-inline" style="width:100px">
            <input name="date" class="layui-input" id="dtStartTime" placeholder="yyyy-MM-dd" type="text" autocomplete="off">
        </div>
        <label class="layui-form-label">时间止</label>
        <div class="layui-input-inline" style="width:100px">
            <input name="date" class="layui-input" id="dtEndTime" placeholder="yyyy-MM-dd" type="text" autocomplete="off">
        </div>
        <button class="layui-btn" type="submit" onclick="Query(1)">查询</button>
    </div>
    <table class="layui-table">
        <thead>
            <tr>
                <th style="width:180px">船舶</th>
                <th style="width:180px">报警时间</th>
                <th style="width:120px">摄像机编号</th>
                <th style="width:150px">摄像机名称</th>
                <th>睡觉</th>
                <th>打架</th>
                <th>安全帽</th>
                <th>手机</th>
            </tr>
        </thead>
        <tbody id="tblist">
        </tbody>
    </table>
    <div id="pages" class="center"></div>
</div>