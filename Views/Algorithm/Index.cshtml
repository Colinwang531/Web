
@{
    ViewData["Title"] = "Index";
    Layout = null;
}
<script src="~/layui/layui.js"></script>
<link href="~/layui/css/layui.css" rel="stylesheet" />
<script type="text/javascript">
    layui.use(['table', 'form'], function () {
        var $ = layui.$;
        var table = layui.table;
        var form = layui.form;
        var DISABLED = 'layui-btn-disabled';
        var tableIns = table.render({
            elem: '#algoTable',
            url: '/Algorithm/Load',
            toolbar: '#userToolBar',
            cols: [[
                {
                    field: 'type', title: "算法类型", width: 150, sort: true, templet: function (e) {
                        if (e.type == 1) return "安全帽";
                        else if (e.type == 2) return "打电话";
                        else if (e.type == 3) return "睡觉";
                        else if (e.type == 4) return "打架";
                        else if (e.type == 5) return "考勤入";
                        else if (e.type == 6) return "考勤出";
                    }
                },
                { field: 'nickName', title: "摄像机名称", width: 150, sort: true },
                { field: 'gpu', title: "GPU", width: 100, sort: true },
                { field: 'detectThreshold_1', title: "检测阀值1", width: 150 },
                { field: 'detectThreshold_2', title: "检测阀值2", width: 150},
                { field: 'trackThreshold', title: "跟踪阀值", width: 150},
                { field: 'similar', title: '人脸相似度', width: 150, sort: true },
                { fiexd: 'right', title: '操作', toolbar: '#userBar', width: 200, algin: 'center' }
            ]],
            done: function (res) {
                if (res.code == 0) {
                    var camera = res.camera;
                    var html = '<option value = ""> 请选择</option>';
                    for (var i = 0; i < camera.length; i++) {
                        html += '<option value="' + camera[i].id + '">' + camera[i].nickName + '</option>'
                    }
                    $("#slCamera").html(html);
                }
                form.render();
            }
        })
        table.on("toolbar(algoTable)", function (obj) {
            if (obj.event == "add") {
                layer.open({
                    type: 1,
                    content: $("#divSaveOrUpdate"),
                    area: ["400px", "500px"],
                    success: function () {
                        $("#dataFrm")[0].reset();
                        SetCSS(1);
                        $("#hidId").val("");
                        $("#selType").val("");
                        $("#slCamera").val("");
                        $("#slgpu").val("");
                        form.render();
                    }
                });
            }
        });
        table.on("tool(algoTable)", function (obj) {
            var data = obj.data;
            if (obj.event == "edit") {
                layer.open({
                    type: 1,
                    content: $("#divSaveOrUpdate"),
                    area: ["400px", "500px"],
                    success: function (res) {
                        $("#hidId").val(data.id);
                        $("#selType").val(data.type);
                        $("#slCamera").val(data.cid);
                        $("#txtThreshold_1").val(data.detectThreshold_1);
                        $("#txtThreshold_2").val(data.detectThreshold_2);
                        $("#txtTrack").val(data.trackThreshold == 0 ? "" : data.trackThreshold);
                        $("#txtSimilar").val(data.similar == 0 ? "" : data.similar);
                        $("#slgpu").val(data.gpu);
                        SetCSS(data.type);
                    }
                })
                form.render();
            } else if (obj.event == "del") {
                layer.confirm('真的删除行么', function (index) {
                    obj.del();
                    layer.close(index);
                    $.ajax({
                        url: "/Algorithm/Delete",
                        type: "get",
                        dataType: "json",
                        data: { id: data.id },
                        contentType: "application/json;chartset=utf-8",
                        success: function (res) {
                            if (res.code == 1) {
                                layer.msg(res.msg, { icon: 2 });
                            } else {
                                layer.msg("删除成功", { icon: 1 });
                                tableIns.reload();
                            }
                        }
                    });
                });
            }
        });
        //保存
        form.on("submit(doSubmit)", function (frm) {
            var DISABLED = 'layui-btn-disabled';
            $('#btnSubmit').attr('disabled', 'disabled').addClass(DISABLED);
            var data = {
                id: frm.field.id,
                type: parseInt(frm.field.type),
                cid: frm.field.camera,
                gpu: frm.field.gpu,
                similar: frm.field.similar,
                detectThreshold_1: frm.field.detectThreshold_1,
                detectThreshold_2: frm.field.detectThreshold_2,
                trackThreshold: frm.field.trackThreshold
            };
            $.ajax({
                url: "/Algorithm/Save",
                data: {
                    model: JSON.stringify(data)
                },
                type: "get",
                dataType: "json",
                contentType: "application/json;charset=utf-8",
                success: function (res) {
                    if (res.code == 1) {
                        layer.msg(res.msg, { icon: 2 });
                    } else {
                        layer.msg("保存成功", { icon: 1 });
                        tableIns.reload();
                        layer.closeAll();
                    }
                    $("#btnSubmit").removeAttr('disabled').removeClass(DISABLED);
                }
            });
            return false;
        });
        form.on("select(type)", function (obj) {
            SetCSS(obj.value);
        })
        //自定义验证规则
        form.verify({
            similar: function (value) {
                var reg = /^0\.(([1-9])|([1-9]\d))$/;
                var type = $("#selType").val();
                if (type == 5 || type == 6) {
                    if (!new RegExp(reg).test(value)) {
                        return "人脸相似度只能转入0-1之间的小数，如0.99";
                    }
                }
            },
            threshold: function (value) {
                var reg = /^0\.(([1-9])|([1-9]\d))$/;
                var type = $("#selType").val();
                var track = $("#txtTrack").val();
                if (type==2) {
                    if (!new RegExp(reg).test(value)) {
                        return "跟踪阀值的取值范围是0-1，如0.99";
                    }
                }else if (track=="") {

                }else if (!new RegExp(reg).test(value)) {
                    return "阀值的取值范围是0-1，如0.99";
                }
            }
        });
        function SetCSS(value) {
            //人脸相似度是否可填
            if (value == 5) {
                $("#txtSimilar").removeAttr("disabled").css("background-color", "");
            }//打电话时跟踪阀值可设置
            else if (value == 2) {
                $("#txtTrack").removeAttr("disabled").css("background-color", "");
            }
            else {
                //人脸不可设置
                $("#txtSimilar").attr("disabled", "disabled").css("background-color", "#EEEEEE");
                $("#txtSimilar").val("");

                $("#txtTrack").attr("disabled", "disabled").css("background-color", "#EEEEEE");
                $("#txtTrack").val("");
            }
            form.render('select');
        }
    });

</script>
<div style="margin:20px;width:70%">
    <table class="layui-hide" id="algoTable" lay-filter="algoTable"></table>
    <div style="display:none" id="userToolBar">
        <button class="layui-btn layui-btn-sm" lay-event="add">增加</button>
    </div>
    <div style="display:none" id="userBar">
        <a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>
        <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>
    </div>
</div>
<div style="display:none" id="divSaveOrUpdate">
    <form class="layui-form" id="dataFrm" layer-filter="dataFrm" action="">
        <input name="id" id="hidId" type="hidden" class="layui-input" />
        <div class="layui-form-item">
            <div class="layui-inline">
                <label class="layui-form-label">算法类型：</label>
                <div class="layui-input-inline">
                    <select name="type" id="selType" lay-verify="required" lay-filter="type">
                        <option value="">请选择</option>
                        <option value="1" selected="selected">安全帽</option>
                        <option value="2">打电话</option>
                        <option value="3">睡觉</option>
                        <option value="4">打架</option>
                        <option value="5">考勤入</option>
                        <option value="6">考勤出</option>
                    </select>
                </div>
            </div>
            <div class="layui-inline">
                <label class="layui-form-label">检测阀值1</label>
                <div class="layui-input-inline">
                    <input type="text" name="detectThreshold_1" id="txtThreshold_1" lay-verify="threshold" autocomplete="off" class="layui-input">
                </div>
            </div>
            <div class="layui-inline">
                <label class="layui-form-label">检测阀值2</label>
                <div class="layui-input-inline">
                    <input type="text" name="detectThreshold_2" id="txtThreshold_2" lay-verify="threshold" autocomplete="off" class="layui-input">
                </div>
            </div>
            <div class="layui-inline">
                <label class="layui-form-label">跟踪阀值</label>
                <div class="layui-input-inline">
                    <input type="text" name="trackThreshold" id="txtTrack" lay-verify="threshold" autocomplete="off" class="layui-input">
                </div>
            </div>
        </div>
        <div class="layui-form-item">
            <div class="layui-inline">
                <label class="layui-form-label">摄像机：</label>
                <div class="layui-input-inline">
                    <select name="camera" id="slCamera" class="layui-input" lay-verify="required" lay-search>
                    </select>
                </div>
            </div>
        </div>
        <div class="layui-form-item">
            <div class="layui-inline">
                <label class="layui-form-label">GPU</label>
                <div class="layui-input-inline">
                    <select name="gpu" id="slgpu" lay-verify="required">
                        <option value="">请选择</option>
                        <option value="0">0</option>
                        <option value="1">1</option>
                    </select>
                </div>
            </div>
            <div class="layui-inline">
                <label class="layui-form-label">相似度</label>
                <div class="layui-input-inline">
                    <input type="text" name="similar" id="txtSimilar" lay-verify="similar" autocomplete="off" class="layui-input">
                </div>
            </div>
        </div>
        <div class="layui-form-item" style="text-align:center">
            <div class="layui-input-block">
                <button type="submit" id="btnSubmit" class="layui-btn layui-btn-normal layui-btn-sm layui-icon layui-icon-release" lay-filter="doSubmit" lay-submit="">提交</button>
                <button type="reset" class="layui-btn layui-btn-warm layui-btn-sm layui-icon layui-icon-refresh">重置</button>
            </div>
        </div>
    </form>
</div>