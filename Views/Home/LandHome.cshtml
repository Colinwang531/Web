
@{
    Layout = null;
    ViewData["Title"] = "LandHome";
}

<link href="~/layui/css/layui.css" rel="stylesheet" />
<script src="~/lib/jquery/dist/jquery.js"></script>
<script src="~/layui/layui.js"></script>
<script type="text/javascript">
    var page = 1; //设置首页页码
    var limit = 5; //设置一页显示的条数
    var total; //总条数
    $(function () {
        LoadAlarm();
        getdate();
        $("#ulleft li").click(function () {
            $("li").each(function () {
                if ($(this).attr("class") != null) {
                    $(this).removeClass("layui-this");
                }
            });
            $(this).addClass("layui-this");

        });
    });
    function LoadAlarm() {
        $("#divAlarm").show();
        $("#divShip").hide();
        $("#divUser").hide();
        var data = {
            pageIndex: page,
            pageSize: limit
        }
        $.ajax({
            url: "/Home/LoadAlarm",
            type: "get",
            data: data,
            dataType: "json",
            contentType: "application/json;charset=utf-8",
            success: function (res) {
                if (res.code == 0) {
                    var tb = res.data;
                    var sl = res.ship;
                    if (sl.length > 0) {
                        var slHtml = '<option value="">请选择</option>';
                        for (var i = 0; i < sl.length; i++) {
                            slHtml += '<option value="' + sl[i].id + '">' + sl[i].name + '</option>'
                        }
                        $("#slShip").html(slHtml);
                    }
                    total = res.count;
                    LoadHtml(tb);
                    getPage();
                }
            }
        });
    }
    function ShowShip() {
        $("#divAlarm").hide();
        $("#divShip").show();
        $("#divUser").hide();
        $.ajax({
            url: "/Ship/Load",
            data: {},
            type: "get",
            dataType: "json",
            contentType: "application/json;chartset=utf-8",
            success: function (res) {
                if (res.code == 0) {
                    var html = "";
                    var tb = res.data;
                    if (tb.length > 0) {
                        for (var i = 0; i < tb.length; i++) {
                            html += '<tr>';
                            html += '<td>' + tb[i].name + '</td>';
                            html += '<td>' + (tb[i].flag ? "航行" : "停港") + '</td>';
                            html += '<td><a class="layui-btn layui-btn-primary layui-btn-xs" href="/Embedded/Index/' + tb[i].id + '">详情</a></td>';
                            html += '</tr>';
                        }
                    }
                    $("#tbList").html(html);
                }
            }
        });
    }
    function ShowUser() {
        $("#divAlarm").hide();
        $("#divShip").hide();
        $("#divUser").show();
        var url;
        var mainIndex;
        layui.use(['table', 'form'], function () {
            var table = layui.table;
            var form = layui.form;
            var tableIns = table.render({
                elem: '#userTable',   //渲染的目标对象
                url: '/Users/Load', //数据接口
                toolbar: "#userToolBar",   //表格的工具条
                page: false,  //是否启用分页
                cols: [[   //列表数据
                    { field: 'uid', title: '用户编码', width: 220, sort: true },
                    { field: 'name', title: '用户名', width: 220, sort: true, align: 'center' },
                    {
                        field: 'enableConfigure', title: '配置权限标识', align: 'center', width: 220, templet: function (d) {
                            return d.enableConfigure == true ? '是' : '否';
                        }
                    },
                    {
                        field: 'enablequery', title: '配置查询标识', align: 'center', width: 220, templet: function (d) {
                            return d.enablequery == true ? '是' : '否';
                        }
                    },
                    { fixed: 'right', title: '操作', toolbar: '#userBar', width: 220, align: 'center' }
                ]],
                done: function () {
                    // 隐藏列
                    $(".layui-table-tool-self").css("display", "none");
                }
            });
            //监听头部工具栏事件
            table.on("toolbar(userTable)", function (obj) {
                switch (obj.event) {
                    case 'add':
                        mainIndex = layer.open({
                            type: 1,
                            title: '添加用户',
                            content: $("#saveOrUpdateDiv"),
                            area: ['600px', '400px'],
                            success: function (index) {
                                $("#hidId").val("");
                                //清空表单数据
                                $("#dataFrm")[0].reset();
                                url = "user/addUser.action";
                            }
                        });
                        break;
                };
            });
            //监听工具条
            table.on('tool(userTable)', function (obj) {
                var data = obj.data;
                if (obj.event === 'del') {
                    layer.confirm('真的删除行么', function (index) {
                        obj.del();
                        layer.close(index);
                        $.ajax({
                            url: "/Users/Delete",
                            type: "get",
                            dataType: "json",
                            data: { id: data.id },
                            contentType: "application/json;chartset=utf-8",
                            success: function (res) {
                                if (res.code == 1) {
                                    alert(res.msg);
                                } else {
                                    tableIns.reload();
                                }
                            }
                        });
                    });
                } else if (obj.event === 'edit') {
                    //layer.alert('编辑行：<br>' + JSON.stringify(data))
                    mainIndex = layer.open({
                        type: 1,
                        title: '修改用户',
                        content: $("#saveOrUpdateDiv"),
                        area: ['600px', '400px'],
                        success: function (index) {
                            form.val("dataFrm", data);
                            $("#txtxpwd").val("");
                            $("#txtspwd").val("");
                            url = "user/updateUser.action";
                        },
                        yes: function () {
                            layer.closeAll();
                        }
                    });
                }
            });
            //保存
            form.on("submit(doSubmit)", function (viewobj) {
                var ypwd = "";
                var xpwd = $("#txtxpwd").val();
                var spwd = $("#txtspwd").val();
                var id = $("#hidId").val();
                if (id == undefined || id == "") {
                    if (xpwd == undefined || xpwd == "") {
                        alert("新密码不为空");
                        return false;
                    }
                    if (xpwd != spwd) {
                        alert("前后两次输入的密码不一致");
                        return false;
                    }
                } else {
                    if (xpwd != undefined && xpwd != "") {
                        if (xpwd != spwd) {
                            alert("前后两次输入的密码不一致");
                            return false;
                        }
                    }
                }
                var data = {
                    Id: id,
                    Name: $("#txtUserame").val(),
                    EnableConfigure: $("#ck1").prop("checked"),
                    Enablequery: $("#ck2").prop("checked"),
                    Password: xpwd
                }
                $.ajax({
                    url: "/Users/UserSave",
                    data: { users: JSON.stringify(data) },
                    type: "get",
                    dataType: "json",
                    contentType: "application/json;charset=utf-8",
                    success: function (res) {
                        if (res.code == 1) {
                            layer.msg("数据保存失败", { icon: 5 });
                        } else {
                            alert("数据保存成功");
                            ShowUser();
                            layer.closeAll();
                        }
                    }
                });
                return false;
                //序列化表单数据
                //var params = $("#dataFrm").serialize();
            });

        });
    }
    function LoadUser() {
        $.ajax({
            url: "/Users/Load",
            type: "get",
            dataType: "json",
            data: {},
            contentType: "application/json;chartset=utf-8",
            success: function (res) {
                var html = "";
                if (res.code == 0) {
                    var tb = res.data;
                    if (res.isSet == true) {
                        var create = '<a  class="layui-btn" href="/Users/Create/">添加用户</a>';
                        $("#divCreate").html(create);
                    }
                    if (tb.length > 0) {
                        for (var i = 0; i < tb.length; i++) {
                            html += '<tr>';
                            html += '<td>' + tb[i].uid + '</td>';
                            html += '<td>' + tb[i].name + '</td>';
                            html += '<td>' + (tb[i].enableConfigure ? "是" : "否") + '</td>';
                            html += '<td>' + (tb[i].enablequery ? "是" : "否") + '</td>';
                            html += '<td>';
                            if (res.isSet == true) {
                                html += '<a class="layui-btn layui-btn-xs"  href="Users/Edit/' + tb[i].id + '">修改</a>';
                                html += "<a class=\"layui-btn layui-btn-danger layui-btn-xs\"  href=\"javascript: \" onclick=\"Del('" + tb[i].id + "')\">删除</a>";
                            }
                            html += '</td>';
                            html += '</tr>';
                        }
                    }
                }
                $("#UsertbList").html(html);
            }
        });
    }
    function Del(id) {
        var r = confirm("是否确定要删除吗？");
        if (r == true) {
            $.ajax({
                url: "/Users/Delete",
                type: "get",
                dataType: "json",
                data: { id: id },
                contentType: "application/json;chartset=utf-8",
                success: function (res) {
                    if (res.code == 1) {
                        alert(res.msg);
                    } else {
                        Load();
                    }
                }
            });
        }
    }
    function LoadHtml(tb) {
        var html = "";
        if (tb.length > 0) {
            for (var i = 0; i < tb.length; i++) {
                html += '<tr>';
                html += '<td>' + tb[i].name + '</td>';
                html += '<td>' + tb[i].time + '</td>';
                html += '<td>' + tb[i].cid + '</td>';
                html += '<td>' + tb[i].nickName + '</td>';
                if (tb[i].type == 1) {
                    html += '<td><img style="width:800px;height:30px" ondblclick="showBigImage(this)"  src="data:image/jpeg;base64,' + tb[i].picture + '"/></td>';
                    html += '<td></td>';
                    html += '<td></td>';
                    html += '<td></td>';
                }
                else if (tb[i].type == 2) {
                    html += '<td></td>';
                    html += '<td><img style="width:800px;height:30px"  ondblclick="showBigImage(this)"  src="data:image/jpeg;base64,' + tb[i].picture + '"/></td>';
                    html += '<td></td>';
                    html += '<td></td>';
                } else if (tb[i].type == 3) {
                    html += '<td></td>';
                    html += '<td></td>';
                    html += '<td><img style="width:800px;height:30px" ondblclick="showBigImage(this)"  src="data:image/jpeg;base64,' + tb[i].picture + '"/></td>';
                    html += '<td></td>';
                } else {
                    html += '<td></td>';
                    html += '<td></td>';
                    html += '<td></td>';
                    html += '<td><img style="width:800px;height:30px"  ondblclick="showBigImage(this)" src="data:image/jpeg;base64,' + tb[i].picture + '"/></td>';
                }
            }
        }

        $("#tblist").html(html);
    }
    function showBigImage(e) {
        layui.use('layer', function () { //独立版的layer无需执行这一句
            var $ = layui.jquery, layer = layui.layer; //独立版的layer无需执行这一句
            var x = document.documentElement.clientWidth / 6;
            var y = document.documentElement.clientHeight / 6;
            var windowW = 960;
            var windowH = 540;
            layer.open({
                type: 1,
                offset: [y + "px", x + "px"],
                title: false,
                closeBtn: true,
                id: 'LAY_layuipro',
                shadeClose: true, //点击阴影关闭
                area: [windowW + 'px', windowH + 'px'], //宽高
                content: "<img style=\"position: absolute;width:100%;height:100%\" src=" + $(e).attr('src') + " />"
            });
        });
    }
    function Query(pageIndex, isRefresh = true) {
        var cid = $("#txtUid").val();
        var name = $("#txtName").val();
        var type = $("#slType").val();
        var startTime = $("#dtStartTime").val();
        var endTime = $("#dtEndTime").val();
        var shipId = $("#slShip").val();
        var data = {
            shipId: shipId,
            cid: cid,
            name: name,
            type: parseInt(type),
            startTime: startTime,
            endTime: endTime,
            pageIndex: pageIndex,
            pageSize: limit
        }
        $.ajax({
            url: "/Home/SearchAlarm",
            data: {
                searchModel: JSON.stringify(data)
            },
            type: "get",
            dataType: "json",
            contentType: "application/json;chartset=utf-8",
            success: function (res) {
                if (res.code == 0) {
                    total = res.count;
                    var tb = res.data;
                    LoadHtml(tb);
                    if (isRefresh) {
                        getPage();
                    }
                }
            }
        })
    }
    //时间控件
    function getdate() {
        layui.use('laydate', function () {
            var laydate = layui.laydate;
            var layer = layui.layer;
            laydate.render({
                elem: '#dtStartTime',
                type: 'date'
            });
        });
        layui.use('laydate', function () {
            var laydate = layui.laydate;
            var layer = layui.layer;
            laydate.render({
                elem: '#dtEndTime',
                type: 'date'
            });
        })
    };
    //分页处理
    function getPage() {
        layui.use('laypage', function () {
            var laypage = layui.laypage;
            var layer = layui.layer;
            laypage.render({
                elem: 'pages',
                count: total, //数据总数，从服务端得到
                limit: limit,
                jump: function (obj, first) {
                    page = obj.curr; //改变当前页码
                    limit = obj.limit;
                    if (!first) {
                        Query(page, false);
                    }
                }
            });
        });
    }
   
</script>
<div class="layui-layout layui-layout-admin">
    <div class="layui-header" style="background-color:#393D49">
        <div class="layui-logo">禹创智能科技</div>
        <ul class="layui-nav layui-layout-right">
            <li class="layui-nav-item"><a href="/Login/SignOut">退了</a></li>
        </ul>
    </div>

    <div style="margin-top:10px;width:200px;float:left">
        <div class="layui-side layui-bg-black">
            <div class="layui-side-scroll">
                <!-- 左侧导航区域 -->
                <ul id="ulleft" class="layui-nav layui-nav-tree" lay-filter="test">
                    <li class="layui-nav-item layui-this" onclick="LoadAlarm()">
                        报警信息
                    </li>
                    @if (ViewBag.isAdmin)
                    {
                        <li class="layui-nav-item" onclick="ShowShip()">
                            船舶信息
                        </li>
                        <li class="layui-nav-item" onclick="ShowUser()">用户信息</li>
                    }
                </ul>
            </div>
        </div>

    </div>
    <div style="float:left;margin-top:10px">
        <div id="divAlarm" style="margin-left:10px;">
            <div class="layui-form-item">
                <label class="layui-form-label">编号</label>
                <div class="layui-input-inline" style="width:100px">
                    <input id="txtUid" class="layui-input" type="text" placeholder="请输入" autocomplete="off" lay-verify="required">
                </div>
                <label class="layui-form-label">名称</label>
                <div class="layui-input-inline" style="width:100px">
                    <input id="txtName" class="layui-input" type="text" placeholder="请输入" autocomplete="off" lay-verify="required">
                </div>
                <label class="layui-form-label">类型</label>
                <select id="slType" class="layui-form-label" style="width:100px">
                    <option value="0">请选择</option>
                    <option value="1">睡觉</option>
                    <option value="2">打架</option>
                    <option value="3">安全帽</option>
                    <option value="4">手机</option>
                </select>
                <label class="layui-form-label">船舶</label>
                <select id="slShip" class="layui-form-label" style="width:100px">
                </select>
                <label class="layui-form-label">时间起</label>
                <div class="layui-input-inline" style="width:100px">
                    <input name="date" class="layui-input" id="dtStartTime" placeholder="yyyy-MM-dd" type="text" autocomplete="off">
                </div>
                <label class="layui-form-label">时间止</label>
                <div class="layui-input-inline" style="width:100px">
                    <input name="date" class="layui-input" id="dtEndTime" placeholder="yyyy-MM-dd" type="text" autocomplete="off">
                </div>
                <button class="layui-btn" type="submit" onclick="Query(1)">查询</button>
            </div>
            <table class="layui-table">
                <thead>
                    <tr>
                        <th style="width:180px">船舶</th>
                        <th style="width:180px">报警时间</th>
                        <th style="width:120px">摄像机编号</th>
                        <th style="width:150px">摄像机名称</th>
                        <th>睡觉</th>
                        <th>打架</th>
                        <th>安全帽</th>
                        <th>手机</th>
                    </tr>
                </thead>
                <tbody id="tblist">
                </tbody>
            </table>
            <div id="pages" class="center"></div>
        </div>
        <div id="divShip" style="display:none;margin-left:10px;">
            <table class="layui-table">
                <thead>
                    <tr>
                        <th style="width:200px">船名称</th>
                        <th style="width:200px">船状态</th>
                        <th style="width:200px"></th>
                    </tr>
                </thead>
                <tbody id="tbList">
                </tbody>
            </table>
        </div>
        <div id="divUser" style="display:none;margin-left:10px;">
            <table class="layui-hide" id="userTable" lay-filter="userTable"></table>
            <div style="display: none;" id="userToolBar">
                <button type="button" class="layui-btn layui-btn-sm" lay-event="add">增加</button>
                @*<button type="button" class="layui-btn layui-btn-sm" lay-event="batchDelete">批量删除</button>*@
            </div>

            <div id="userBar" style="display: none;">
                <a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>
                <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>
            </div>


            <div style="display: none;" id="saveOrUpdateDiv">
                <form class="layui-form" action="" id="dataFrm" lay-filter="dataFrm">
                    <input name="id" id="hidId" type="hidden" />
                    <div class="layui-form-item" style="margin-top: 20px;">
                        <div class="layui-inline">
                            <label class="layui-form-label">用户名：</label>
                            <div class="layui-input-inline">
                                <input type="text" id="txtUserame" name="name" maxlength="20" lay-verify="required" autocomplete="off" class="layui-input">
                            </div>
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <div class="layui-inline">
                            <label class="layui-form-label">配置：</label>
                            <div class="layui-input-inline">
                                <input type="checkbox" id="ck1" name="enableConfigure" title="配置权限标识">
                                <input type="checkbox" id="ck2" name="enablequery" title="配置查询标识">
                            </div>
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <div class="layui-inline">
                            <label class="layui-form-label">新密码：</label>
                            <div class="layui-input-inline">
                                <input type="password" id="txtxpwd" maxlength="32" autocomplete="off" class="layui-input">
                            </div>
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <div class="layui-inline">
                            <label class="layui-form-label">确认密码：</label>
                            <div class="layui-input-inline">
                                <input type="password" id="txtspwd" maxlength="32" autocomplete="off" class="layui-input">
                            </div>
                        </div>
                    </div>
                    <div class="layui-form-item" style="text-align: center">
                        <div class="layui-input-block">
                            <button type="submit" class="layui-btn layui-btn-normal layui-btn-sm layui-icon layui-icon-release" lay-filter="doSubmit" lay-submit="">提交</button>
                            <button type="reset" class="layui-btn layui-btn-warm layui-btn-sm layui-icon layui-icon-refresh">重置</button>
                        </div>

                    </div>

                </form>

            </div>
        </div>

    </div>
</div>

